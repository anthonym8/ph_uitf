---
title: "Analysis of UITFs in PH using R"
author: "Rey Anthony Masilang"
output:
  html_document:
    theme: default
    highlight: textmate
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

# {.tabset}

## Data Gathering 

#### **Prerequisites**
First, we'll load necessary libraries. Most of these are from the tidyverse which greatly helps in having a consistent workflow.

```{r message=FALSE, warning=FALSE, results="hide"}
library(dplyr)      # for data frame wrangling
library(readr)      # for reading and writing flat files
library(stringr)    # for string manipulation
library(lubridate)  # for date string parsing
library(purrr)      # for tidy functional programming

library(ggplot2)    # for most of the graphs
library(ggiraph)    # for adding interactive tooltips to ggplot graphs
library(DT)         # for interactive output data tables

library(rvest)      # for parsing html tables
library(XML)        # for parsing html
library(RCurl)      # for parsing html
```
<br />

#### **Comprehensive UITF List**

For our first dataset, we'll pull basic information about the available UITFs in the Philippines from [uitf.com](http://www.uitf.com.ph). We'll use the *rvest* package to parse tables in web pages then save it as CSV to our local folder.  

After loading the file with our specified column data types, we transform the date columns from strings to dates using functions from the *lubridate* package. Take a glimpse at a portion of the data we just extracted.

```{r}
url <- "http://www.uitf.com.ph/print_matrix.php?sort=&sortby=bank&sortorder=asc&class_id=&currency="

# parse and save data in to local folder
if(!file.exists("./Datasets/uitf_df.csv")) {
    read_html(url) %>% 
        html_nodes(xpath='//*[@class="hovertable"]') %>% 
        html_table() %>% 
        `[[`(1) %>% 
        write_csv("Datasets/uitf_df.csv")
}

# load data into memory
uitf_df <- read_csv("./Datasets/uitf_df.csv", col_types = "ccccccnnncccccccn") %>% 
    mutate(`Inception Date` = mdy(`Inception Date`), `Last Uploaded Date` = mdy(`Last Uploaded Date`))

# show a snippet of our data frame
datatable(uitf_df[c(1,2,3,5)], 
          filter = "none", 
          rownames = FALSE,
          class = 'stripe',
          options = list(dom = "pt",
                         pagelength = 100,
                         autoWidth = TRUE
                         )
          )

```
<br />

#### **Scraping Daily Price Data**
To compare the performance of these UITFs, we need the following for each UITF:

* Ticker symbol used in Bloomberg 
* Daily prices for the past year  
<br />

##### **Extracting Ticker Symbols thru Google Search**
There aren't many sites offering daily prices of all UITFs in our list. Bank websites show data for their products only of course and parsing each individual site is inefficient. **uitf.com** has all the data we need but is unscrapable because it requires you to answer a captcha first.  

So we're going to pull daily price data from [bloomberg.com](https://www.bloomberg.com/) through a clever hack. But first we need to know the ticker symbols used for each UITF in bloomberg. There's no readily available data for this so we'll have to rely on Google's intelligence for this one.
<br /><br />

##### **Our custom Google query function**
This function queries *Google Search* and returns the ticker symbol we need. All we need to do is pass it a string which will be used for our google search. The string follows this format: `www.bloomberg.com/quote` + `<bank name>` + `<UITF name>`.

```{r message=FALSE, warning=FALSE}

search_bloomberg_symbol <- function(search_string) {
    
    # query google search and parse html document
    html <- getForm("https://www.google.com.ph/search", hl="tl", lr="", q=search_string, btnG="Search") %>%
        htmlTreeParse()
    
    # descend through html hierarchy to narrow down our search
    html_flat <- html$children$html[2]$body[2]$table[4]$tbody[2]$tr[2]$td[1]$div[2]$div[2]$div[1]$div[1]$ol[1]$div %>% unlist()
    
    # a little string processing to extract our symbol
    if(is.null(html_flat)) {
        symbol <- NA
    } else {
        symbol <- data_frame(Name = names(html_flat), Value = html_flat) %>% 
        filter(str_detect(Name, "\\.text\\.value")) %>% 
        `[[`(2) %>% 
        paste(collapse=" ") %>% 
        str_replace(".*quote", "") %>% 
        str_replace(":PM.*", "") %>% 
        str_replace_all("/", "") %>% 
        str_trim() %>% 
        str_split(pattern = " ") %>% 
        unlist() %>% 
        paste(collapse = "")
    }

    return(symbol)
}

```
<br />


##### **Querying Google Search for Ticker Symbols**
We use our custom function above to extract ticker symbols from google search results for each UITF. Using this method, not all UITFs were correctly matched to their symbols. It is very likely that these UITFs do not have data hosted on [bloomberg.com](http://www.bloomberg.com) so we just have to exclude them from our analysis.
```{r message=FALSE, warning=FALSE}

if(!file.exists("./Datasets/uitf_symbols.csv")) {
    
    # prepare search strings for each UITF
    uitf_symbols <- uitf_df %>% 
    select(Bank, `Fund Name`) %>%
    mutate(search_string = paste("www.bloomberg.com/quote", `Fund Name`)) %>% 
    mutate(Symbol = NA)
    
    # query symbols for all UITFs
    for(i in 1:nrow(uitf_symbols)) {
        search_string <- uitf_symbols$search_string[i]
        uitf_symbols$Symbol[i] <- search_bloomberg_symbol(search_string)
        message(paste0(i, " out of ", nrow(uitf_symbols)))
    }
    
    # save to local folder then cleanup memory
    write_csv(uitf_symbols, "Datasets/uitf_symbols.csv")
    rm(uitf_symbols, search_string)
}

# reload symbol table and remove erroneous symbols
uitf_symbols <- read_csv("Datasets/uitf_symbols.csv") %>% 
    select(Bank, `Fund Name`, Symbol) %>% 
    mutate(Symbol = ifelse(str_length(Symbol) > 7, NA, Symbol)) %>% 
    mutate(Symbol = ifelse(str_length(Symbol) < 6, NA, Symbol)) %>% 
    mutate(Symbol = ifelse(!is.na(Symbol), paste(Symbol, "PM", sep=":"), NA))
    
# display results
datatable(uitf_symbols, 
          filter = "none", 
          rownames = FALSE,
          class = 'stripe',
          options = list(dom = "pt",
                         pagelength = 100,
                         autoWidth = TRUE
                         )
          )

# remove rows without results for symbol query
uitf_symbols <- filter(uitf_symbols, Symbol == "")
```
<br />














<br />






## Initial Analysis


#### **BPI has the widest array of UITF products among banks in PH**
Plotting the number of different UITF products per bank shows BPI having the largest portfolio with 27 different products followed by BDO with 21 and Metrobank with 17.

```{r warning=FALSE}
plot <- uitf_df %>% 
    transmute(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    group_by(Bank) %>% 
    mutate(Portfolio_Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Bank, desc(Portfolio_Count)))) +
    geom_bar_interactive(aes(tooltip = ..count..), fill = "darkgreen") +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8, hjust=1, angle=90)
    ) + 
    labs(title = "Portfolio Size per Bank",
         x = "",
         y = "Count")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />


#### **Top banks offer a mix of moderate risk and aggressive types of UITFs**

```{r warning=FALSE}
plot <- uitf_df %>% 
    select(Bank, Risk = `Risk Classification`) %>% 
    mutate(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Bank) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Bank, desc(Count)), fill=Risk)) +
    geom_bar_interactive(aes(tooltip = ..count..), position = "fill") +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, vjust=0.5, angle=90),
          legend.title = element_text(size = 9),
          legend.text = element_text(size = 8),
          legend.position = "top"
    ) + 
    labs(title = " Portfolio Risk Ratio per Bank",
         x = "Bank",
         y = "Ratio") +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_brewer(type="seq", palette = "Set1")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />


#### **Aggressive UITFs are mostly comprised of equity-tracking funds**
Aggressive equity funds track the Philippine Stock Exchange index (PSEi) 100% or in combination with another industry index. Moderate risk UITFs on the other hand are composed of a wider class of funds from balanced funds to bond funds and some money-market funds. Last, conservative funds are mostly money-market funds which are invested in short-term debt securities like treasury bills.

```{r warning=FALSE}
plot <- uitf_df %>% 
    select(Risk = `Risk Classification`, Classification) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Risk) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Classification, desc(Count)), fill=Risk)) +
    geom_bar_interactive(aes(tooltip = ..count..)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, angle=90),
          legend.position = "none"
    ) + 
    facet_grid(. ~ Risk, scales = "free_x", space = "free_x") +
    labs(title = "UITF breakdown by Risk Flavor and Fund Category",
         x = "Category",
         y = "Count") +
    scale_fill_brewer(palette = "Set1")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />
<br />
<br />


