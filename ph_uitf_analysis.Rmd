---
title: "Analysis of UITFs in PH using R"
author: "Rey Anthony Masilang"
output:
  html_document:
    theme: default
    highlight: textmate
    code_folding: hide
---



# {.tabset}



## Prerequisites 

#### **Libraries**
First, we'll load necessary libraries. Most of these are from the tidyverse which greatly helps in having a consistent workflow.

```{r message=FALSE, warning=FALSE, results="hide"}
library(dplyr)      # for data frame wrangling
library(readr)      # for reading and writing flat files
library(stringr)    # for string manipulation
library(lubridate)  # for date string parsing
library(purrr)      # for tidy functional programming

library(ggplot2)    # for most of the graphs
library(ggiraph)    # for adding interactive tooltips to ggplot graphs
library(DT)         # for interactive output data tables

library(rvest)      # for parsing html tables
library(XML)        # for parsing html
library(RCurl)      # for parsing html
```
<br />

#### **Initial Data Gathering**

For our first dataset, we'll pull basic information about the available UITFs in the Philippines from [uitf.com](http://www.uitf.com.ph). We'll use the *rvest* package to parse the table from web pages into a data frame then save it as CSV to our local folder.  

After loading the file with our specified column data types, we transform the date columns from strings to dates using functions from the *lubridate* package.

```{r}
url <- "http://www.uitf.com.ph/print_matrix.php?sort=&sortby=bank&sortorder=asc&class_id=&currency="
if(!file.exists("./Datasets/uitf_df.csv")) {
    read_html(url) %>% 
        html_nodes(xpath='//*[@class="hovertable"]') %>% 
        html_table() %>% 
        `[[`(1) %>% 
        write_csv("Datasets/uitf_df.csv")
}

# load data into memory
uitf_df <- read_csv("./Datasets/uitf_df.csv", col_types = "ccccccnnncccccccn") %>% 
    mutate(`Inception Date` = mdy(`Inception Date`), `Last Uploaded Date` = mdy(`Last Uploaded Date`))

```
<br />

#### **UITF Matrix**
```{r}
datatable(uitf_df, 
          filter = "none", 
          rownames = FALSE,
          class = 'stripe',
          options = list(dom = "tp",
                         pagelength = 10))
```
<br />
<br />






## Initial Analysis


#### **BPI has the widest array of UITF products among banks in PH**
Plotting the number of different UITF products per bank shows BPI having the largest portfolio with 27 different products followed by BDO with 21 and Metrobank with 17.

```{r warning=FALSE}
plot <- uitf_df %>% 
    transmute(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    group_by(Bank) %>% 
    mutate(Portfolio_Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Bank, desc(Portfolio_Count)))) +
    geom_bar_interactive(aes(tooltip = ..count..), fill = "darkgreen") +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8, hjust=1, angle=90)
    ) + 
    labs(title = "Portfolio Size per Bank",
         x = "",
         y = "Count")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />


#### **Top banks offer a mix of moderate risk and agressive types of UITFs**

```{r warning=FALSE}
plot <- uitf_df %>% 
    select(Bank, Risk = `Risk Classification`) %>% 
    mutate(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Bank) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Bank, desc(Count)), fill=Risk)) +
    geom_bar_interactive(aes(tooltip = ..count..), position = "fill") +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, vjust=0.5, angle=90),
          legend.title = element_text(size = 9),
          legend.text = element_text(size = 8),
          legend.position = "top"
    ) + 
    labs(title = " Portfolio Risk Ratio per Bank",
         x = "Bank",
         y = "Ratio") +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_brewer(type="seq", palette = "Set1")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />


#### **Agressive UITFs are mostly comprised of equity-tracking funds**
Agressive equity funds track the Philippine Stock Exchange index (PSEi) 100% or in combination with another industry index. Moderate risk UITFs on the other hand are composed of a wider class of funds from balanced funds to bond funds and some money-market funds. Last, conservative funds are mostly money-market funds which are invested in short-term debt securities like treasury bills.

```{r warning=FALSE}
plot <- uitf_df %>% 
    select(Risk = `Risk Classification`, Classification) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Risk) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Classification, desc(Count)), fill=Risk)) +
    geom_bar_interactive(aes(tooltip = ..count..)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, angle=90),
          legend.position = "none"
    ) + 
    facet_grid(. ~ Risk, scales = "free_x", space = "free_x") +
    labs(title = "UITF breakdown by Risk Flavor and Fund Category",
         x = "Category",
         y = "Count") +
    scale_fill_brewer(palette = "Set1")

ggiraph(ggobj = plot, height_svg=6, width_svg = 9, width = 1)
```
<br />


#### **Next steps...**
In the next part of this analysis, we'll look at the differences between these UITFs by category and by risk flavor in terms of fund performance. But first, I'll explain in the next tab how I gathered additional data for this analysis.
<br />
<br />
<br />


## Scraping Web Data

#### **Required data**
To compare the performance of these UITFs, we need the daily prices for the past year for each UITF. 

#### **Symbol Parser**
note to self: bloomberg scraper https://www.bloomberg.com/markets/chart/data/1Y/BPIEQUI:PM

```{r message=FALSE, warning=FALSE}

search_bloomberg_symbol <- function(search_string) {
    
    # query google search and parse html document
    html <- getForm("https://www.google.com/search", hl="tl", lr="", q=search_string, btnG="Search") %>% 
        htmlTreeParse()
    
    # descend through html hierarchy to extract UITF symbol
    symbol <- html$children$html[2]$body[2]$table[4]$tbody[2]$tr[2]$td[1]$div[2]$div[2]$div[1]$div[1]$ol[1]$div[1]$h3[1]$a[1]$text %>% 
        toString() %>% 
        str_split(pattern = " ") %>% 
        unlist() %>% 
        `[`(1)
    
    return(symbol)
}
    
```
<br />


```{r}
selected_uitf <- uitf_df %>% 
    mutate(Benchmark = tolower(Benchmark)) %>%
    filter(str_detect(Benchmark, "psei") | str_detect(Benchmark, "stock exchange")) %>% 
    mutate(percent = ifelse(!str_detect(Benchmark, "%"), 
                            100,
                            str_extract(Benchmark, pattern = "[:digit:]+%") %>% 
                                str_replace("%", "") %>% 
                                as.numeric())) %>% 
    filter(percent == 100) %>% 
    select(Bank, `Fund Name`) %>%
    mutate(search_string = paste("www.bloomberg.com/quote", `Fund Name`, sep = " ")) %>% 
    mutate(Symbol = NA)

# for(i in seq_along(selected_uitf$search_string)) {
#     search_string <- selected_uitf$search_string[i]
#     selected_uitf$Symbol[i] <- search_bloomberg_symbol(search_string)
#     message(paste0(i, " out of ", nrow(selected_uitf)))
# }

```














