---
title: "Analysis of UITFs in PH using R"
author: "Rey Anthony Masilang"
output:
  html_document:
    theme: default
    highlight: textmate
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
```

<!-- # {.tabset .tabset-pills} -->

<br />

## Introduction
<br />

## Data Preparation

```{r message=FALSE, warning=FALSE, results="hide"}
library(dplyr)          # for data frame wrangling
library(readr)          # for reading and writing flat files
library(stringr)        # for string manipulation
library(lubridate)      # for date string parsing
library(purrr)          # for tidy functional programming\
library(tidyr)          # for data frame reshaping
library(rjson)          # for parsing json files

library(ggplot2)        # for most of the graphs
library(ggiraph)        # for adding interactive tooltips to ggplot graphs
library(RColorBrewer)   # for custom plotting colors
library(DT)             # for outputting interactive data tables
library(knitr)          # for outputting html kable tables
library(rmarkdown)      # for outputting html paged tables

library(rvest)          # for parsing html tables
library(XML)            # for parsing html
library(RCurl)          # for parsing html

```
<br />

#### **Comprehensive UITF List**

For our first dataset, we'll pull basic information about the available UITFs in the Philippines from [uitf.com](http://www.uitf.com.ph). We'll use the `rvest` package to parse tables in web pages then save it as CSV to our local folder.  

After loading the file with our specified column data types, we transform the date columns from strings to dates using functions from the `lubridate` package. Take a glimpse at a portion of the data we just extracted.

```{r}
url <- "http://www.uitf.com.ph/print_matrix.php?sort=&sortby=bank&sortorder=asc&class_id=&currency="

# parse and save data in to local folder
if(!file.exists("./Datasets/uitf_df.csv")) {
    read_html(url) %>% 
        html_nodes(xpath='//*[@class="hovertable"]') %>% 
        html_table() %>% 
        `[[`(1) %>% 
        write_csv("Datasets/uitf_df.csv")
}

# load data into memory
uitf_df <- read_csv("./Datasets/uitf_df.csv", col_types = "ccccccnnncccccccn") %>% 
    mutate(`Inception Date` = mdy(`Inception Date`), `Last Uploaded Date` = mdy(`Last Uploaded Date`))

# show a snippet of our data frame
paged_table(uitf_df[c(1,2,3,5)])

```
<br />

#### **Scraping Daily Price Data**
To compare the performance of these UITFs, we need the following for each UITF:

* Ticker symbol used in Bloomberg 
* Daily prices for the past year  
<br />

##### **Extracting Ticker Symbols thru Google Search**
There aren't many sites offering daily prices of all UITFs in our list. Bank websites show data for their products only of course and parsing each individual site is inefficient. **uitf.com** has all the data we need but is unscrapable because it requires you to answer a captcha first.  

So we're going to pull daily price data from [bloomberg.com](https://www.bloomberg.com/) through a clever hack. But first we need to know the ticker symbols used for each UITF in bloomberg. There's no readily available data for this so we'll have to rely on Google's intelligence for this one.
<br /><br />

##### **Our custom Google query function**
This function queries *Google Search* and returns the ticker symbol we need. All we need to do is pass it a string which will be used for our google search. The string follows this format: `www.bloomberg.com/quote` + `<bank name>` + `<UITF name>`.

```{r message=FALSE, warning=FALSE}

search_bloomberg_symbol <- function(search_string) {
    
    # query google search and parse html document
    html <- getForm("https://www.google.com.ph/search", hl="tl", lr="", q=search_string, btnG="Search") %>%
        htmlTreeParse()
    
    # descend through html hierarchy to narrow down our search
    html_flat <- html$children$html[2]$body[2]$table[4]$tbody[2]$tr[2]$td[1]$div[2]$div[2]$div[1]$div[1]$ol[1]$div %>% unlist()
    
    # a little string processing to extract our symbol
    if(is.null(html_flat)) {
        symbol <- NA
    } else {
        symbol <- data_frame(Name = names(html_flat), Value = html_flat) %>% 
        filter(str_detect(Name, "\\.text\\.value")) %>% 
        `[[`(2) %>% 
        paste(collapse=" ") %>% 
        str_replace(".*quote", "") %>% 
        str_replace(":PM.*", "") %>% 
        str_replace_all("/", "") %>% 
        str_trim() %>% 
        str_split(pattern = " ") %>% 
        unlist() %>% 
        paste(collapse = "")
    }

    return(symbol)
}

```
<br />


##### **Querying Google Search for Ticker Symbols**
We use our custom function above to extract ticker symbols from google search results for each UITF. Using this method, not all UITFs were correctly matched to their symbols. It is very likely that these UITFs do not have data hosted on [bloomberg.com](http://www.bloomberg.com) so we just have to exclude them from our analysis.
```{r message=FALSE, warning=FALSE}

if(!file.exists("./Datasets/uitf_symbols.csv")) {
    
    # prepare search strings for each UITF
    uitf_symbols <- uitf_df %>% 
    select(Bank, `Fund Name`) %>%
    mutate(search_string = paste("www.bloomberg.com/quote", `Fund Name`)) %>% 
    mutate(Symbol = NA)
    
    # query symbols for all UITFs
    for(i in 1:nrow(uitf_symbols)) {
        search_string <- uitf_symbols$search_string[i]
        uitf_symbols$Symbol[i] <- search_bloomberg_symbol(search_string)
        message(paste0(i, " out of ", nrow(uitf_symbols)))
    }
    
    # save to local folder then cleanup memory
    write_csv(uitf_symbols, "Datasets/uitf_symbols.csv")
}

# reload symbol table and remove erroneous symbols
uitf_symbols <- read_csv("Datasets/uitf_symbols.csv") %>% 
    select(Bank, `Fund Name`, Symbol) %>% 
    mutate(Symbol = ifelse(str_length(Symbol) > 7, NA, Symbol)) %>% 
    mutate(Symbol = ifelse(str_length(Symbol) < 6, NA, Symbol)) %>% 
    mutate(Symbol = ifelse(!is.na(Symbol), paste(Symbol, "PM", sep=":"), NA))
    
# display a portion of the results
uitf_symbols %>% 
    distinct(Symbol, .keep_all=TRUE) %>% 
    sample_n(5) %>% 
    paged_table()

```
<br />


Before we pull daily price data, let's make sure to clean up our dataset first. Duplicate symbols are red flags for incorrect symbols.
```{r warning=FALSE}

# look for symbols with duplicates
duplicate_symbols <- uitf_symbols$Symbol %>% 
    table() %>% 
    as_data_frame() %>% 
    filter(n > 1)

# show duplicate symbols
print(duplicate_symbols)

```
<br />

That's a lot of duplicates. Let's see which UITFs from our list have these symbols matched to them. From this point, we just have to manually check which ones have incorrectly labelled symbols and remove them from out UITF list. It's very likely that bloomberg does not have daily price data for these which is why our google query returned inaccurate results.

```{r warning=FALSE, message=FALSE}

# create duplicates table
duplicates <- uitf_symbols %>% 
    filter(Symbol %in% duplicate_symbols[[1]]) %>% 
    arrange(Symbol)

paged_table(duplicates)

# remove rows with correct labels from our duplicates table
duplicates <- duplicates[-c(1,5,9,11,13,16,17,20,22,26,29,30,32,34,36,39), ]

# remove duplicates from out uitf_symbols dataframe
uitf_symbols <- uitf_symbols %>% 
    anti_join(duplicates) %>% 
    filter(Symbol != "") %>% 
    filter(!is.na(Symbol))

# clean up workspace
rm(duplicates, duplicate_symbols)

```



<br />

##### **Pulling Daily Prices from Bloomberg.com**
Now that we have the ticker symbols for most of the UITFs in our matrix, we can pull daily price data for each one for the past year. We'll get this data from Bloomberg using this simple hack which exposes the raw data used in their graphs. We just have to access their site as follows: `www.bloomberg.com/markets/chart/data/1Y/` + `<ticker symbol>`. This returns the raw data in `JSON` format. See example below for `BPIEQUI:PM`.

```{r message=FALSE, warning=FALSE}
# parse JSON data and show first 10 elements
fromJSON(file = "https://www.bloomberg.com/markets/chart/data/1Y/BPIEQUI:PM") %>% 
    `[[`("data_values") %>% 
    `[`(1:10) %>% 
    list("data_values" = .) %>% 
    toJSON()
```

<br />
We merge all data for all UITFs in a long data frame and then save to a local folder again. At this point we're more concerned with collecting data first so this format ensures we don't lose any data during collection. Later on we will reshape this data frame as needed in our subsequent analyses.
```{r message=FALSE, warning=FALSE}

# initialize price data frame
price_data <- data_frame(Date = as.Date(vector()),
                         NAVPU = double(),
                         UITF = character())

# extract data from web
if(!file.exists("./Datasets/uitf_daily_prices_raw.csv")) {
    for(i in 1:nrow(uitf_symbols)) {
    
        # progress tracker
        message(paste0("Extracting data | ", i, " out of ", nrow(uitf_symbols)))
    
        # build url
        url <- paste0("https://www.bloomberg.com/markets/chart/data/1Y/", uitf_symbols$Symbol[i])
    
        # download raw JSON data
        json_data <- fromJSON(file= url)[["data_values"]]
        if(length(json_data) == 0) next()
    
        # transform to data frame
        uitf_daily_prices <- json_data %>% 
            unlist() %>% 
            matrix(ncol = 2, byrow = TRUE, 
                   dimnames = list(c(), c("Date", "NAVPU"))) %>% 
            as_data_frame()  %>% 
            mutate(Date = as.Date(as.POSIXlt(Date/1000, origin = "1970-01-01"))) %>%
            mutate(UITF = uitf_symbols$Symbol[i])
    
        # merge to price data
        price_data <- bind_rows(price_data, uitf_daily_prices)
    }

    # save data to local folder
    write_csv(price_data, "Datasets/uitf_daily_prices_raw.csv")
    rm(url, json_data, uitf_daily_prices, price_data, search_bloomberg_symbol)
}

# load data
price_data <- read_csv("./Datasets/uitf_daily_prices_raw.csv")

# show some data
print(price_data)


```

<br />
We can have a quick look at our data using a trend chart. Since the prices are on relatively different scales, this graph does not provide much insight and majority of UITFs are compressed in the lower region of the y-axis. However, this confirms that we have our data in a nice format we can work with later on.
```{r warning=FALSE, message=FALSE}

# sample 30 UITFs to show in trend chart
set.seed(10)
sample_UITFs <- sample(price_data$UITF, 30)

# plot trend chart
plot <- price_data %>%
    filter(UITF %in% sample_UITFs) %>% 
    ggplot(aes(x=Date, y=NAVPU, col=UITF, group=UITF, tooltip=UITF)) +
    geom_line_interactive(lwd=1, alpha=0.8) +
    labs(x = "",
         y = "Net Asset Value per Unit",
         title = "Daily NAVPUs from 2016/04/26 to 2017/04/25") +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5))

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1, tooltip_opacity=0.8)

```

To compare these UITFs, the raw daily price data must be converted in terms of percent return relative to the earliest price in our data for each UITF (Apr 26, 2016).

```{r warning=FALSE, message=FALSE}

# get reference prices 1 year before Apr 25, 2017
first_prices <- price_data %>% 
    group_by(UITF) %>% 
    arrange(UITF, Date) %>% 
    slice(1) %>% 
    select(UITF, First_Price = NAVPU)

# calculate %returns
returns_data <- price_data %>% 
    group_by(UITF) %>% 
    arrange(UITF, Date) %>% 
    left_join(first_prices) %>% 
    mutate(Return = ((NAVPU/First_Price)-1)*100) %>% 
    ungroup() %>% 
    select(UITF, Date, Return)

# plot all UITF trends
plot <- returns_data %>% 
    filter(UITF %in% sample_UITFs) %>% 
    ggplot(aes(x=Date, y=Return, col=UITF, group=UITF, tooltip=UITF)) +
    geom_line_interactive(lwd=1, alpha=0.8) +
    labs(x = "",
         y = "Returns (%)",
         title = "Overlay of % Return Trends") +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5))

ggiraph(ggobj=plot, height_svg=5, width_svg=9, width=1, tooltip_opacity=0.8)

```
<br />


## Overview of UITFs
<br />

#### **BPI has the widest array of UITF products among banks in PH**
Plotting the number of different UITF products per bank shows BPI having the largest portfolio with 27 different products followed by BDO with 21 and Metrobank with 17.

```{r warning=FALSE}
plot <- uitf_df %>% 
    transmute(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    group_by(Bank) %>% 
    summarize(Portfolio_Count = n()) %>% 
    ungroup() %>% 
    mutate(tooltip = paste(paste0("Bank: ", Bank),
                           paste0("Products: ", Portfolio_Count),
                           sep = "\n")) %>% 
    ggplot(aes(x=reorder(Bank, desc(Portfolio_Count)), 
               y=Portfolio_Count, 
               tooltip = tooltip,
               label = Portfolio_Count)) +
    geom_bar_interactive(stat = "identity", fill = "darkgreen", width = 0.95) +
    geom_label(nudge_y = 1.5, alpha=0.4) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size = 8, hjust=1, angle=90),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()
    ) + 
    labs(title = "Portfolio Size per Bank",
         x = "",
         y = "")

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />


#### **Timeline of UITF Inceptions**
Looking at the dotplot below, we see that BPI was the first to introduce a couple of UITFs in 1994. We also have the largest number of UITF introductions on 2005 from multiple banks and another series of introductions from 2013 to 2016.

```{r warning=FALSE, message=FALSE}
# update our uitf matrix with those which we have daily price data only
uitf_df <- uitf_df %>% 
    inner_join(uitf_symbols)

# initialize custom categorical colors
all_qual_palettes <- brewer.pal.info %>% 
    mutate(Palette = rownames(.)) %>% 
    filter(category == "qual") %>% 
    select(Palette, maxcolors)

all_qual_colors <- map2(all_qual_palettes$maxcolors,
                            all_qual_palettes$Palette,
                            brewer.pal) %>% 
    unlist()

my_qual_colors <- all_qual_colors[1:length(unique(uitf_df$Bank))]


# dot plot
plot <- uitf_df %>% 
    select(Bank, `Fund Name`, `Inception Date`) %>% 
    mutate(Year = year(`Inception Date`)) %>% 
    mutate(Bank_full_name = Bank) %>% 
    mutate(Bank = paste0(str_sub(Bank, start=1, end=20), "...")) %>% 
    mutate(tooltip = paste(paste0("Bank:\t", Bank_full_name), 
                           paste0("Fund Name:\t", `Fund Name`), 
                           paste0("Birthday:\t", `Inception Date`), 
                           sep="\n")) %>% 
    arrange(Bank, `Fund Name`) %>% 
    group_by(Year) %>%
    mutate(Rank = 1:n()) %>% 
    mutate(Rank = Rank - mean(Rank)) %>% 
    ggplot(aes(x = Year, y = Rank, col = Bank)) +
    geom_point_interactive(aes(tooltip = tooltip), size = 3.5) +
    coord_cartesian(xlim = c(1994, 2018)) +
    scale_x_continuous(breaks = seq(1990,2020, by = 2)) +
    scale_y_continuous(breaks = NULL) +
    labs(x = "Year", y = "", title = "Timeline of UITF Inceptions") +
    theme(legend.text = element_text(size = 9),
          legend.key.size = unit(5, "mm"),
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(vjust = 0.5, angle = 0)) +
    scale_fill_manual(values = my_qual_colors) +
    scale_color_manual(values = my_qual_colors)

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />


#### **Top banks offer a mix of moderate risk and aggressive types of UITFs**

```{r warning=FALSE}
# plot <- uitf_df %>% 
#     select(Bank, Risk = `Risk Classification`) %>% 
#     mutate(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
#     mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
#     group_by(Bank) %>% 
#     mutate(Count = n()) %>% 
#     ungroup() %>% 
#     ggplot(aes(x=reorder(Bank, desc(Count)), fill=Risk)) +
#     geom_bar_interactive(aes(tooltip = ..prop..), position = "fill", width = 0.95) +
#     theme(plot.title = element_text(hjust = 0.5, size = 12),
#           axis.title.y = element_text(size = 9),
#           axis.text.y = element_text(size = 8),
#           axis.title.x = element_text(size = 9),
#           axis.text.x = element_text(size = 8, hjust=1, vjust=0.5, angle=90),
#           legend.title = element_text(size = 9),
#           legend.text = element_text(size = 8),
#           legend.position = "top"
#     ) + 
#     labs(title = " Portfolio Risk Ratio per Bank",
#          x = "Bank",
#          y = "Ratio") +
#     scale_y_continuous(labels = scales::percent) +
#     scale_fill_brewer(type="seq", palette = "Set1")

plot <- uitf_df %>% 
    select(Bank, Risk = `Risk Classification`) %>% 
    mutate(Bank = paste0(str_sub(Bank, 1, 30), "...")) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Bank, Risk) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    group_by(Bank) %>% 
    mutate(Ratio = Count/n()) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(tooltip = paste(paste0("Bank: ", Bank),
                           paste0("Risk: ", Risk),
                           paste0(format(100*Ratio, digits=2), "%"),
                           sep="\n")) %>% 
    ggplot(aes(x=reorder(Bank, desc(Count)), y = Ratio, 
               fill=Risk, tooltip=tooltip)) +
    geom_bar_interactive(stat = "identity", position = "fill", width = 0.95, alpha=0.75) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, vjust=0.5, angle=90),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_line(size=1),
          legend.title = element_text(size = 9),
          legend.text = element_text(size = 8),
          legend.position = "top"
    ) + 
    labs(title = " Portfolio Risk Ratio per Bank",
         x = "Bank") +
    scale_y_continuous(labels = scales::percent, expand=c(0,0)) +
    scale_x_discrete(expand=c(0,0)) +
    scale_fill_brewer(type="seq", palette = "Set1")


ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />


#### **Aggressive UITFs are mostly comprised of equity-tracking funds**
Aggressive equity funds track the Philippine Stock Exchange index (PSEi) 100% or in combination with another industry index. Moderate risk UITFs on the other hand are composed of a wider class of funds from balanced funds to bond funds and some money-market funds. Last, conservative funds are mostly money-market funds which are invested in short-term debt securities like treasury bills.

```{r warning=FALSE, message=FALSE}
plot <- uitf_df %>% 
    select(Risk = `Risk Classification`, Classification) %>% 
    mutate(Risk = factor(Risk, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    group_by(Risk) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    ggplot(aes(x=reorder(Classification, desc(Count)), fill=Risk)) +
    geom_bar_interactive(aes(tooltip = ..count..)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, angle=90),
          legend.position = "none"
    ) + 
    facet_grid(. ~ Risk, scales = "free_x", space = "free_x") +
    labs(title = "UITF breakdown by Risk Flavor and Fund Category",
         x = "Category",
         y = "Count") +
    scale_fill_brewer(palette = "Set1")

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />
<br />
<br />

## Performance Analysis
<br />

#### **Top Performing UITFs**
In this section we will review which UITFs performed best for the past year. Our key metric is year-over-year returns (YOY) from Apr 26, 2016 to Apr 25, 2017. The table below shows all UITFs and their performance in descending order. Feel free to navigate through each bank and/or each classification.

```{r warning=FALSE, message=FALSE}
# custom function for price selection
get_price <- function(Date, NAVPU, target_date) {
    NAVPU[Date == target_date]
}

# summarize performance of each UITF
perf_summ <- price_data %>% 
    group_by(UITF) %>% 
    # get prices for current date and 1 year ago
    mutate(price_latest = get_price(Date, NAVPU, max(Date))) %>% 
    mutate(price_1Y_ago = get_price(Date, NAVPU, min(Date))) %>% 
    filter(Date >= ymd("2017-01-01")) %>% 
    # get prices at start of 2017
    mutate(price_startOfYear = get_price(Date, NAVPU, min(Date))) %>% 
    select(UITF, starts_with("price_")) %>% 
    ungroup() %>% 
    unique() %>% 
    # calculate YTD and YOY returns
    mutate(YTD = 100*(price_latest/price_startOfYear - 1)) %>% 
    mutate(YOY = 100*(price_latest/price_1Y_ago - 1)) %>% 
    select(Symbol = UITF, YTD, YOY) %>% 
    arrange(desc(YTD)) %>% 
    # merge UITF info
    inner_join(uitf_df[, c("Symbol", "Bank", "Fund Name", "Classification", "Risk Classification")])

# prepare output table
top_uitfs <- perf_summ %>% 
    arrange(desc(YOY)) %>% 
    mutate(YOY = round(YOY, digits = 2),
           YTD = round(YTD, digits = 2)) %>% 
    select(Bank, Symbol, Classification, YOY, YTD) %>% 
    mutate(Bank = factor(Bank), Classification = factor(Classification))

# display interactive data table
datatable(top_uitfs, 
          filter = "top", 
          class = 'stripe',
          options = list(dom = "pt",
                         pagelength = 20,
                         autoWidth = TRUE
                         )
          )    
    
```
<br />

##### **Money Market Funds**
```{r warning=FALSE, message=FALSE}



```


#### **ROI**

```{r warning=FALSE, message=FALSE}

plot <- price_data %>% 
    group_by(UITF) %>% 
    mutate(Price_Date = ifelse(Date == min(Date), "Old", NA)) %>% 
    mutate(Price_Date = ifelse(Date == max(Date), "New", Price_Date)) %>% 
    na.omit() %>% 
    select(UITF, NAVPU, Price_Date) %>% 
    spread(Price_Date, NAVPU) %>% 
    mutate(YOY = 100*(New/Old - 1)) %>% 
    arrange(desc(YOY)) %>% 
    inner_join(uitf_df[, c("Symbol", "Bank", "Fund Name", "Classification", "Risk Classification")], by = c("UITF" = "Symbol")) %>% 
    ggplot(aes(x = Classification, y = YOY, fill = Classification, col = Classification)) +
    geom_violin(width = 1.5) +
    geom_boxplot_interactive(col = "black", fill = "white", width = 0.07, alpha = 0.5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(y = "Year over Year (%)")

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)

```
<br />
<br />
<br />

## Risk Analysis
<br />


## Conclusion
<br />


