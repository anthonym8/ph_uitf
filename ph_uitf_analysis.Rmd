---
title: "Analysis of UITFs in PH using R"
author: "Rey Anthony Masilang"
output:
  html_document:
    theme: default
    highlight: textmate
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
```

<!-- # {.tabset .tabset-pills} -->

<br />




# Introduction

This notebook documents my analysis on Unit Investment Trust Funds. The motivation for this is that I'm looking to invest again in UITFs. What's good about UITFs is that you can have a diversified investment with low capital and at the convenience of having professional portfolio managers handle these funds for you. This time however, I plan to be more knowledgeable before I dive in so I can know all my options and plan on a good enough strategy to meet my investment objectives.

Specific questions in mind for this analysis are the following:

1. What are the available UITFs in the Philippines? Which banks offer them?
2. What are the different classes of UITFs? How do they differ from one another?
3. Which can be considered the best if I'm aiming for good returns from my investment? Or if I want to preserve my capital?

Also note that this is an R markdown notebook. Feel free to expand the code chunks if you're interested in looking at the code used for this analysis.

<br />




# Data Gathering & Preparation

This section describes the data gathering and processing steps. You can skip to the next section to start reading about the actual analysis. Below are the three raw data sets required for this analysis. The data gathering and preprocessing steps are described after.

|     | Raw Data                  | Description                                   |
|:---:|:--------------------------|:----------------------------------------------|
|  1  | Complete UITF List        | Complete list of the names and ticker symbols of all available UITFs in the Philippines + some basic info |
|  2  | Daily Price Data          | Daily price data for the the past year for each                                      UITF |
|  3  | Fund Information          | All other important information including fund and risk classifications, etc. for each UITF |

<br />
These 3 raw data sets will then be transformed into our pair of working datasets which are:

|     | Processed Data            | Description                                   |
|:---:|:--------------------------|:----------------------------------------------|
|  1  | UITF Matrix               | Comprehensive data frame containing all important information on all available UITFs |
|  2  | Daily Percent Returns     | Daily price data for the past year represented as percent returns relative to starting date |

```{r message=FALSE, warning=FALSE, results="hide"}

# clear workspace
rm(list = ls())

# load R packages
library(dplyr)          # for data frame wrangling
library(readr)          # for reading and writing flat files
library(stringr)        # for string manipulation
library(lubridate)      # for date string parsing
library(purrr)          # for tidy functional programming
library(tidyr)          # for data frame reshaping
library(rjson)          # for parsing json files
library(Hmisc)          # for string cleaning

library(ggplot2)        # for most of the graphs
library(ggiraph)        # for adding interactive tooltips to ggplot graphs
library(RColorBrewer)   # for custom plotting colors
library(DT)             # for outputting interactive data tables
library(rmarkdown)      # for outputting html paged tables

library(rvest)          # for parsing html tables
library(XML)            # for parsing html
library(RCurl)          # for parsing html

```

### Raw Data: **UITF List**

#### Pulling all PH ticker symbols from Bloomberg

For our first dataset, we'll pull a list of all available UITFs from [Bloomberg.com](https://www.bloomberg.com/markets/symbolsearch?). This is done using Bloomberg's symbol lookup tool. We're going to do a basic search for all ticker symbols for all Philippines-based stocks and products. From this set, we'll filter in only those symbols for UITFs, our product of interest.

```{r warning=FALSE, message=FALSE}

# scrape PH symbols from bloomberg.com
if(!file.exists("./Datasets/all_symbols.csv")) {
    # query bloomberg symbol lookup: "PH"
    url <- "https://www.bloomberg.com/markets/symbolsearch?query=PH"
    
    # initialize results table
    all_symbols <- data_frame(Symbol = character(),
                              Name = character(),
                              Country = character(),
                              Type = character(),
                              `Industry/Objective` = character())
    
    # scrape all pages of query results
    for(i in 1:199) {
        result <- read_html(paste0(url, "&page=", i)) %>% 
            html_nodes(xpath='//*[@class="dual_border_data_table alt_rows_stat_table tabular_table"]') %>% 
            html_table()
        
        all_symbols <- bind_rows(all_symbols, result)
    }
    
    # save results to local folder
    write_csv(all_symbols, "./Datasets/all_symbols.csv")
    rm(all_symbols, url, result)
}

# load to memory
all_symbols <- read_csv("./Datasets/all_symbols.csv") %>% 
    select(Symbol, Name, Country, Type)

# show first 5 rows in document
paged_table(head(all_symbols, n=3))

```
<br />

We will do a quick filter for just PH open-end fund type symbols. Next is we need to remove other fund types from this dataset such as mutual funds and VULs since we're only interested in UITFs. For this, we need need to gather info from each symbol's quote page from [Bloomberg.com/quote/<ticker symbol>](https://www.bloomberg.com/quote) such as fund profile, inception date, currency, etc. We can access some of the information in this quote page in JSON format using this web address: `https://www.bloomberg.com/markets/api/quote-page/` + `<ticker symbol>`

```{r warning=FALSE, message=FALSE}

# gather basic info for each symbol
if(!file.exists("./Datasets/symbol_info.csv")) {
    
    # filter in PH open-end funds only
    symbol_info <- all_symbols %>% 
        filter(Country == "PH", Type == "Open-End Fund") %>% 
        select(Symbol, Name) %>% 
        mutate(Profile = "", 
               Website = "",
               `Fund Type` = "",
               `Inception Date` = "",
               Currency = "")
    
    # scrape profile and other info for each symbol
    for(i in 1:nrow(symbol_info)) {
        print(i)
        
        # construct url for json data
        url <- paste0("https://www.bloomberg.com/markets/api/quote-page/",
                      filtered_symbols$Symbol[i])
        
        # scrape json data
        json_data <- fromJSON(file = url) %>% 
            unlist() %>% 
            data_frame(key = names(.), value = .)
        
        # define function for extracting specific values from json data
        find_value <- function(keyword, df) {
            ifelse(
                !any(str_detect(json_data$key, keyword)), 
                NA, 
                df %>% 
                    filter(str_detect(key, keyword)) %>% 
                    slice(1) %>% 
                    `[[`("value")
            )
        }
        
        # assign values to data frame
        symbol_info$Profile[i] <- find_value("profile\\.description", json_data)
        symbol_info$Website[i] <- find_value("profile\\.website", json_data)
        symbol_info$`Fund Type`[i] <- find_value("fundType", json_data)
        symbol_info$`Inception Date`[i] <- find_value("inceptionDate", json_data)
        symbol_info$Currency[i] <- find_value("issuedCurrency", json_data)
        
        # clean up workspace
        rm(url, json_data, find_value)
    }
    
    # save to local folder
    write_csv(symbol_info, "./Datasets/symbol_info.csv")
    rm(i, symbol_info)
}

symbol_info <- read_csv("./Datasets/symbol_info.csv")

# fill in missing values for Fund Type column
for(i in which(is.na(symbol_info$`Fund Type`))) {
    symbol_info$`Fund Type`[i] <- if(str_detect(tolower(symbol_info$Profile[i]), "trust")) {
        "Unit Trust"
    } else {
        NA
    }
}
rm(i, all_symbols)

```

#### Complete UITF List

All these additional data are gathered to screen out all non-UITF symbols from our list and also for mapping them to their fund and risk classifications later. You can view our clean data below.

```{r warning=FALSE, message=FALSE}

# filter in UITFs only
all_UITFs <- symbol_info %>% 
    filter(`Fund Type` == "Unit Trust") %>% 
    mutate(Website = str_replace(Website, "http:", "")) %>% 
    mutate(Website = str_replace_all(Website, "/", ""))

# fill in missing values for Website column
all_UITFs$Website[is.na(all_UITFs$Website) & str_detect(all_UITFs$Profile, "Rizal")] <- "www.rcbc.com"

# manually define bank-website mapping ala dictionary
bank_websites <- list(`AB Capital` = "www.abcapitalonline.com",
                      ATRAM = "www.atram.com.ph",
                      `Asia United Bank` = "www.aub.com.ph",
                      `Bank of Commerce` = "www.bankcom.com.ph",
                      BDO = "www.bdo.com.ph",
                      BPI = "www.bpiexpressonline.com",
                      `China Bank` = "www.chinabank.ph",
                      EastWest = "www.eastwestbanker.com",
                      MetroBank = "www.metrobank.com.ph",
                      PBCOM = "www.pbcom.com.ph",
                      PNB = "www.pnb.com.ph",
                      RCBC = "www.rcbc.com",
                      `Security Bank` = "www.securitybank.com.ph",
                      UCPB = "www.ucpb.com",
                      `Union Bank` = "www.unionbankph.com") %>% 
    data_frame(Bank = names(.), Website = .) %>% 
    mutate(Website = as.character(Website))

# clean fund name function
clean_fund_name <- function(fund_name) {
    fund_name %>% 
    str_split(" ") %>% 
        unlist() %>% 
        map_chr(
            function(x){
                ifelse(
                    x %in% c("AB", "ATRAM", "AUB", "U.S.", "US", "ABF", "CBC", "GS", "II", "III", "PNB", "SB", "UCPB", "US$", "PSEI", "PSEi", "BDO", "BPI", "CTBC", "RCBC", "BOC", "UBP"),
                    x, capitalize(tolower(x))
                )
            }
        ) %>% 
        paste(collapse = " ") %>% 
        str_trim()
}

# merge bank info
all_UITFs <- all_UITFs %>% 
    left_join(bank_websites) %>% 
    select(Symbol, Name, Bank, Currency, `Inception Date`) %>% 
    mutate(Name = map_chr(Name, clean_fund_name)) %>% 
    unique()

# clean up
rm(bank_websites, symbol_info)

paged_table(head(all_UITFs, n = 3))

```
<br />


### Raw Data: **Daily Price Data**

Now that we have a complete list of UITFs, we can pull daily price data for each one for the past year. We'll get this data from Bloomberg using this simple hack which exposes the raw data used in their graphs. We just have to access their site as follows: `www.bloomberg.com/markets/chart/data/1Y/` + `<ticker symbol>`. This returns the raw data in `JSON` format. See example below for `BPIEQUI:PM`.
<br />

We merge all data for all UITFs in a long data frame and then save to a local folder again. At this point we're more concerned with collecting data first so this format ensures we don't lose any data during collection. Later on we will reshape this data frame as needed in our subsequent analyses.
```{r message=FALSE, warning=FALSE}

# initialize price data frame
price_data <- data_frame(Date = as.Date(vector()),
                         NAVPU = double(),
                         Symbol = character())

# extract data from web
if(!file.exists("./Datasets/uitf_daily_prices_raw.csv")) {
    for(i in 1:nrow(all_UITFs)) {
    
        # progress tracker
        print(paste0("Extracting data | ", i, " out of ", nrow(all_UITFs)))
    
        # build url
        url <- paste0("https://www.bloomberg.com/markets/chart/data/1Y/", all_UITFs$Symbol[i])
    
        # download raw JSON data
        json_data <- fromJSON(file= url)[["data_values"]]
        if(length(json_data) == 0) next()
    
        # transform to data frame
        uitf_daily_prices <- json_data %>% 
            unlist() %>% 
            matrix(ncol = 2, byrow = TRUE, 
                   dimnames = list(c(), c("Date", "NAVPU"))) %>% 
            as_data_frame()  %>% 
            mutate(Date = as.Date(as.POSIXlt(Date/1000, origin = "1970-01-01"))) %>%
            mutate(Symbol = all_UITFs$Symbol[i])
    
        # merge to price data
        price_data <- bind_rows(price_data, uitf_daily_prices)
    }

    # save data to local folder
    write_csv(price_data, "Datasets/uitf_daily_prices_raw.csv")
    rm(i, url, json_data, uitf_daily_prices, price_data)
}

# load data
price_data <- read_csv("./Datasets/uitf_daily_prices_raw.csv") %>% 
    unique()

# show some data
print(price_data)


```
<br />


### Raw Data: **Fund Information**

For our last raw dataset, we'll pull basic information about the available UITFs in the Philippines from [uitf.com](http://www.uitf.com.ph). We'll use the `rvest` package to parse tables in web pages then save it as CSV to our local folder. Take a glimpse at a portion of the data we just extracted.

```{r warning=FALSE, message=FALSE}

# parse and save data in to local folder
if(!file.exists("./Datasets/fund_info.csv")) {
    url <- "http://www.uitf.com.ph/print_matrix.php?sort=&sortby=bank&sortorder=asc&class_id=&currency="
    read_html(url) %>% 
        html_nodes(xpath='//*[@class="hovertable"]') %>% 
        html_table() %>% 
        `[[`(1) %>% 
        write_csv("Datasets/fund_info.csv")
}

# manually define bank name mappings ala dictionary
bank_names <- list(`AB Capital` = "AB Capital",
                    ATRAM = "ATRAM Trust Corporation",
                    `Asia United Bank` = "Asia United Bank",
                    `Bank of Commerce` = "Bank of Commerce",
                    BDO = "BDO Unibank, Inc.",
                    BPI = "BPI Asset Management and Trust Corporation",
                    `China Bank` = "China Banking Corporation",
                    `CTBC Bank` = "CTBC Bank (Philippines) Corp.",
                    DBP = "Development Bank of the Philippines",
                    EastWest = "EastWest Banking Corporation",
                    LandBank = "LandBank of the Philippines",
                    MetroBank = "Metropolitan Bank & Trust Co.",
                    PBCOM = "Philippine Bank of Communications",
                    `Phil. Business Bank` = "Philippine Business Bank",
                    PNB = "Philippine National Bank",
                    PSBank = "Philippine Savings Bank",
                    `RCBC Savings` = "RCBC Savings",
                    RCBC = "Rizal Commercial Banking Corporation",
                    `Robinsons Bank` = "Robinsons Bank",
                    `Security Bank` = "Security Bank Corporation",
                   `Sterling Bank of Asia` = "Sterling Bank of Asia",
                    UCPB = "United Coconut Planters Bank",
                    `Union Bank` = "Union Bank") %>% 
    data_frame(Bank = names(.), `Bank Name` = .) %>% 
    mutate(`Bank Name` = as.character(`Bank Name`))

# load data into memory then clean data
fund_info <- read_csv("./Datasets/fund_info.csv", col_types = "ccccccnnncccccccn") %>% 
        mutate(`Inception Date` = mdy(`Inception Date`), `Last Uploaded Date` = mdy(`Last Uploaded Date`)) %>% 
    mutate(`Fund Name` = str_replace(`Fund Name`, "\\(.*\\)", "")) %>% 
    select(`Bank Name` = Bank, 
           `Fund Name`, 
           `Fund Classification` = Classification,
           `Risk Classification`,
           `Inception Date`,
           Currency,
           `Min. Initial Participation`,
           `Min. Additional Participation`,
           `Min. Holding Period`,
           `Trust Fee Structure`,
           `Early Redemption Fee`,
           Benchmark,
           `Last Uploaded Date`,
           `Latest NAVpu`) %>% 
    left_join(bank_names) %>% 
    select(Bank, everything(), -`Bank Name`) %>% 
    mutate(`Fund Classification` = str_replace(`Fund Classification`, "Money - Market", "Money Market")) %>% 
    mutate(`Fund Name` = map_chr(`Fund Name`, function(x){ clean_fund_name(x) }))

# clean up
rm(bank_names, i, clean_fund_name)

# show a snippet of our data frame
fund_info %>% 
    select(`Bank`, `Fund Name`, `Fund Classification`, `Risk Classification`, everything()) %>% 
    head(n = 3) %>% 
    paged_table()

```
<br />


### Processed Data: **UITF Matrix**

So far we have two tables which have various info on UITFs. First is the *UITF List* which contains all UITF names and their ticker symbols which is our link to our last dataset, the price data. Second is the *Fund Info* table which contains all other relevant information such as fund and risk classifications among others. For our working dataset, we need to merge these two tables together.  

Each table has a fund name for each UITF. However, the fund names are not standard between the two sources, UITF.com and Bloomberg.com. We have lots of other information for each table so we're going to use these cleverly to be able to merge these two tables. Expand the code chunk below to see how this was done.

```{r message=FALSE, warning=FALSE}

# match UITFs with exact same names between tables
fund_info_labelled <- fund_info %>% 
    filter(Bank %in% all_UITFs$Bank) %>% 
    mutate(string_to_match = tolower(`Fund Name`)) %>% 
    left_join(transmute(all_UITFs, string_to_match = tolower(Name), Symbol = Symbol, `Match Name` = Name)) %>% 
    select(-string_to_match)

# label UITFs with same bank and inception date
for(i in which(is.na(fund_info_labelled$Symbol))) {
    match <- all_UITFs %>% 
        filter(Bank == fund_info_labelled$Bank[i]) %>% 
        filter(Currency == fund_info_labelled$Currency[i]) %>% 
        filter(`Inception Date` == fund_info_labelled$`Inception Date`[i]) %>% 
        `[`(c("Symbol", "Name"))
    
    if(nrow(match) == 1 && !(match$Symbol %in% fund_info_labelled$Symbol)) {
        fund_info_labelled$Symbol[i] <- match$Symbol
        fund_info_labelled$`Match Name`[i] <- match$Name
    }
    
    rm(match)
}

# label UITFs with exact same Bank, currency, and NAVPU at latest date
temp_price_data <- price_data %>% 
    left_join(all_UITFs[, c("Symbol", "Name", "Bank", "Currency")]) %>% 
    unique()

for(i in which(is.na(fund_info_labelled$Symbol))) {
    
    ref_price <- fund_info_labelled$`Latest NAVpu`[i]
    n_digits <- (ref_price - floor(ref_price)) %>% 
        sprintf("%f", .) %>% 
        str_replace("0\\.", "") %>% 
        str_replace("0*$", "") %>% 
        nchar()
    
    match <- temp_price_data %>% 
        filter(Bank == fund_info_labelled$Bank[i]) %>% 
        filter(Currency == fund_info_labelled$Currency[i]) %>% 
        filter(Date == fund_info_labelled$`Last Uploaded Date`[i]) %>% 
        filter(floor(NAVPU*10^n_digits) == ceiling(ref_price*10^n_digits)) %>% 
        `[`(c("Symbol", "Name"))
    
    if(nrow(match) == 1 && !(match$Symbol %in% fund_info_labelled$Symbol)) {
        fund_info_labelled$Symbol[i] <- match$Symbol
        fund_info_labelled$`Match Name`[i] <- match$Name
    }
    
    rm(match, ref_price, n_digits)
}

# label UITFs with exact same Bank, currency, and approximately the same NAVPU at latest date
for(i in which(is.na(fund_info_labelled$Symbol))) {
    
    ref_price <- fund_info_labelled$`Latest NAVpu`[i]
    
    match <- temp_price_data %>% 
        filter(Bank == fund_info_labelled$Bank[i]) %>% 
        filter(Currency == fund_info_labelled$Currency[i]) %>% 
        filter(Date == fund_info_labelled$`Last Uploaded Date`[i]) %>% 
        mutate(price_error = abs(ref_price - NAVPU)) %>% 
        filter(price_error < 0.01) %>% 
        `[`(c("Symbol", "Name", "price_error"))
    
    
    if(nrow(match) >= 1) {
        if(nrow(match) > 1) {
            match <- match %>% 
                arrange(price_error) %>% 
                slice(1)
        }
        
        if(!(match$Symbol %in% fund_info_labelled$Symbol)) {
            fund_info_labelled$Symbol[i] <- match$Symbol
            fund_info_labelled$`Match Name`[i] <- match$Name
        }
        
    }
    
    rm(match, ref_price, n_digits)
}

# select columns
fund_info_labelled <- fund_info_labelled %>% 
    select(Symbol, everything(), -Bank, -`Inception Date`, -Currency, -`Last Uploaded Date`, -`Latest NAVpu`, -`Match Name`)

# merge the two tables
UITF_matrix <- left_join(all_UITFs, fund_info_labelled, by = "Symbol") %>% 
    mutate(`Risk Classification` = map_chr(`Risk Classification`, function(x){ ifelse(is.na(x), "Unknown", x) })) %>% 
    mutate(`Risk Classification` = factor(`Risk Classification`, levels=c("Aggressive", "Moderate", "Conservative"))) %>% 
    filter(!is.na(`Risk Classification`))


# clean up workspace
rm(fund_info_labelled, temp_price_data, i)

# show head of UITF_matrix
paged_table(head(UITF_matrix, n=3))

```
<br />


### Processed Data: **Daily Percent Returns**

#### Quick look at our data

We can have a quick look at our data using a trend chart. Since the prices are on relatively different scales, this graph does not provide much insight and majority of UITFs are compressed in the lower region of the y-axis. However, this confirms that we have our data in a nice format we can work with later on.

```{r warning=FALSE, message=FALSE}

# sample 30 UITFs to show in trend chart
set.seed(10)
sample_UITFs <- sample(price_data$Symbol, 30)

# plot trend chart
plot <- price_data %>%
    filter(Symbol %in% sample_UITFs) %>% 
    ggplot(aes(x=Date, y=NAVPU, col=Symbol, group=Symbol, tooltip=Symbol)) +
    geom_line_interactive(lwd=1, alpha=0.8) +
    labs(x = "",
         y = "Net Asset Value per Unit",
         title = "Daily NAVPUs from 2016/04/26 to 2017/04/25") +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5))

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1, tooltip_opacity=0.8)

```
<br />

#### Calculating returns

To compare these UITFs, the raw daily price data must be converted in terms of percent return relative to the earliest price in our data for each UITF (Apr 26, 2016). Take a look at the same subset of our price data represented as %returns.

```{r warning=FALSE, message=FALSE}

# get reference prices 1 year before Apr 25, 2017
first_prices <- price_data %>% 
    group_by(Symbol) %>% 
    arrange(Symbol, Date) %>% 
    slice(1) %>% 
    select(Symbol, First_Price = NAVPU)

# calculate %returns
returns_data <- price_data %>% 
    group_by(Symbol) %>% 
    arrange(Symbol, Date) %>% 
    left_join(first_prices) %>% 
    mutate(Return = ((NAVPU/First_Price)-1)*100) %>% 
    ungroup() %>% 
    select(Symbol, Date, Return)

# plot all UITF trends
plot <- returns_data %>% 
    filter(Symbol %in% sample_UITFs) %>% 
    ggplot(aes(x=Date, y=Return, col=Symbol, group=Symbol, tooltip=Symbol)) +
    geom_line_interactive(lwd=1, alpha=0.8) +
    labs(x = "",
         y = "Returns (%)",
         title = "Overlay of % Return Trends") +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5))

# clean up workspace
rm(sample_UITFs, first_prices)

ggiraph(ggobj=plot, height_svg=5, width_svg=9, width=1, tooltip_opacity=0.8)

```
<br />




# Overview of Funds

### Bank Portfolios

Overall, there are `r nrow(UITF_matrix)` active UITFs in the Philippines. The graph below shows BPI having the largest portfolio with `r sum(UITF_matrix$Bank == "BPI")` different products followed by Security Bank with `r sum(UITF_matrix$Bank == "Security Bank")` and BDO with `r sum(UITF_matrix$Bank == "BDO")`.

```{r warning=FALSE}

plot_data <- UITF_matrix %>% 
    select(Bank, Currency, Product = Name) %>% 
    mutate(Product = paste("-", Product)) %>% 
    arrange(Product) %>% 
    group_by(Bank) %>% 
    mutate(Total = n()) %>% 
    ungroup() %>% 
    group_by(Bank, Currency) %>% 
    mutate(Count = n()) %>%
    mutate(Products = paste(Product, collapse = "\n")) %>% 
    select(-Product) %>% 
    mutate(tooltip = paste(Bank,
                           paste(Count, "out of", Total , "products"),
                           Products,
                           sep = "\n")) %>% 
    ungroup() %>% 
    unique() %>% 
    mutate(Currency = factor(Currency, levels = c("USD", "PHP"))) 

plot <- plot_data %>% 
    ggplot(aes(x = reorder(Bank, desc(Total)), 
               y = Count,
               fill = Currency, 
               tooltip = tooltip)) +
    geom_bar_interactive(stat = "identity") +
    geom_text(data = unique(plot_data),
              aes(label = Total, y = Total),
              nudge_y = 1.5, alpha=0.8) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(hjust=1, vjust=0.5, angle=90),
          axis.ticks.x = element_blank(),
          panel.grid = element_blank(),
          panel.background = element_blank(),
          legend.position = c(0.95, 0.85),
          legend.direction = "vertical"
    ) +
    labs(title = "Portfolio Size per Bank",
         x = "",
         y = "") +
    scale_fill_manual(values = c("forestgreen", "cornflowerblue"))
    
ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)

```
<br />

#### Getting started

One known advantage of UITFs is low initial capital, typically as low as P10,000. From our list of UITFs, let's confirm this.

```{r warning=FALSE, message=FALSE}

# initialize custom categorical colors
my_qual_palette <- function(n) {
    all_qual_palettes <- brewer.pal.info %>% 
        mutate(Palette = rownames(.)) %>% 
        filter(category == "qual") %>% 
        select(Palette, maxcolors)

    map2(all_qual_palettes$maxcolors,
                                all_qual_palettes$Palette,
                                brewer.pal) %>% 
        unlist() %>% 
        `[`(c(1:n))
}

plot <- UITF_matrix %>% 
    select(Bank, Name, Currency, Initial = `Min. Initial Participation`) %>% 
    arrange(Initial) %>% 
    filter(Initial > 0) %>%
    filter(Currency == "PHP") %>% 
    mutate(Initial_labels = as.factor(formatC(as.integer(Initial), big.mark=","))) %>%
    mutate(Initial_scale = as.integer(Initial_labels)) %>% 
    group_by(Currency, Initial) %>%
    arrange(Bank) %>% 
    mutate(Rank = 1:n()) %>% 
    mutate(tooltip = paste(paste(Name),
                           paste("Bank", Bank),
                           paste("Amount:", Currency, Initial_labels),
                           sep = "\n")) %>% 
    ggplot(aes(y = reorder(Initial_labels, Initial), x = Rank, col = Bank)) +
    geom_point_interactive(aes(tooltip = tooltip), size = 3.5) +
    labs(title = "Minimum Initial Participation",
         y = "Minimum Initial Participation (PHP)") +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.background = element_rect(fill = "grey95")) + 
    scale_fill_manual(values = my_qual_palette(length(unique(UITF_matrix$Bank)))) +
    scale_color_manual(values = my_qual_palette(length(unique(UITF_matrix$Bank))))

ggiraph(ggobj = plot, height_svg=4.5, width_svg = 9, width = 1)
```


#### Timeline

Looking at the dotplot below, we see that BPI was the first to introduce a couple of UITFs in 1994. 2005 has seen the largest number of UITF introductions from multiple banks and another series of introductions are seen from 2013 to 2017

```{r warning=FALSE, message=FALSE}

# dot plot
plot <- UITF_matrix %>% 
    select(Bank, Name, `Inception Date`) %>% 
    mutate(Year = year(`Inception Date`)) %>% 
    mutate(Bank_full_name = Bank) %>% 
    mutate(tooltip = paste(paste0("Name:\t", Name), 
                           paste0("Bank:\t", Bank_full_name), 
                           paste0("Inception Date:\t", `Inception Date`), 
                           sep="\n")) %>% 
    arrange(Bank, Name) %>% 
    group_by(Year) %>%
    mutate(Rank = 1:n()) %>% 
    mutate(Rank = Rank - mean(Rank)) %>% 
    ggplot(aes(x = Year, y = Rank, col = Bank)) +
    geom_point_interactive(aes(tooltip = tooltip), size = 3.5) +
    coord_cartesian(xlim = c(1994, 2018)) +
    scale_x_continuous(breaks = seq(1990,2020, by = 2)) +
    scale_y_continuous(breaks = NULL) +
    labs(x = "Year", y = "", title = "Timeline of UITF Inceptions") +
    theme(legend.text = element_text(size = 9),
          legend.key.size = unit(5, "mm"),
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(vjust = 0.5, angle = 0),
          legend.position = "right") +
    scale_fill_manual(values = my_qual_palette(length(unique(UITF_matrix$Bank)))) +
    scale_color_manual(values = my_qual_palette(length(unique(UITF_matrix$Bank))))

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />

### Risk Types

#### Portfolio Risk Breakdown per Bank

Top banks offer a mix of moderate risk and aggressive types of UITFs. BPI offers mostly aggressive-type funds, while the portfolios of both BDO and MetroBank are half aggressive and half moderate types. If you're more inclined to conservative risk types of funds, PNB offers the most number of conservative UITFs.

```{r warning=FALSE}

plot <- UITF_matrix %>% 
    select(Bank, Risk = `Risk Classification`) %>% 
    group_by(Bank) %>% 
    mutate(Total = n()) %>% 
    ungroup() %>% 
    group_by(Bank, Risk) %>% 
    mutate(Count = n()) %>% 
    mutate(tooltip = paste(Bank,
                           paste("Risk:", Risk),
                           paste(Count, "out of", Total , "products"),
                           sep = "\n")) %>%
    ungroup() %>% 
    unique() %>% 
    arrange(desc(Total), Risk) %>%
    ggplot(aes(x = reorder(Bank, desc(Total)), 
               y = Count, 
               fill = Risk, 
               tooltip = tooltip)) +
    geom_bar_interactive(alpha = 0.75, stat = "identity") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(hjust=1, vjust=0.5, angle=90),
          axis.ticks.x = element_blank(),
          panel.grid = element_blank(),
          panel.background = element_blank(),
          legend.position = c(0.5, 0.85),
          legend.direction = "horizontal"
    ) +
    ggtitle("Portfolio Risk Breakdown") +
    scale_fill_brewer(palette = "Set1")

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)

```
<br />


#### Fund Classification by Income Instruments

There are different income instruments which comprise the portfolio of each UITF product such as shares of stock, bonds, and money markets. The type of income instrument basically determines the risk flavor of a UITF. Equity funds are invested in shares of stocks and are classified as aggressive type. Bond funds are invested in either corporate or government bonds and typically have moderate risk. Balanced funds are invested in a combination of stocks and bonds and are still considered aggressive. Finally, money market funds are invested in short-term debt instruments and are considered as conservative.

```{r warning=FALSE, message=FALSE}
plot <- UITF_matrix %>% 
    select(Risk = `Risk Classification`, Classification = `Fund Classification`) %>% 
    group_by(Risk) %>% 
    mutate(Count = n()) %>% 
    ungroup() %>% 
    mutate(tooltip = paste(Classification,
                           paste("Risk:", Risk),
                           paste(Count, "products"),
                           sep = "\n")) %>% 
    ggplot(aes(x=reorder(Classification, desc(Count)), 
               fill=Risk, tooltip = tooltip)) +
    geom_bar_interactive(alpha = 0.75) +
    theme(plot.title = element_text(hjust = 0.5, size = 12),
          axis.title.y = element_text(size = 9),
          axis.text.y = element_text(size = 8),
          axis.title.x = element_text(size = 9),
          axis.text.x = element_text(size = 8, hjust=1, angle=90),
          axis.ticks.x = element_blank(),
          legend.position = "none",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()
    ) + 
    facet_grid(. ~ Risk, scales = "free_x", space = "free_x") +
    labs(title = "UITF breakdown by Risk Flavor and Fund Classification",
         x = "Classification",
         y = "Count") +
    scale_fill_brewer(palette = "Set1") +
    scale_y_continuous(limits = c(0,50), breaks = seq(0,50,10))

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)
```
<br />

# Performance Analysis

### Top Performing UITFs

In this section we will review which UITFs performed best for the past year. Our key metric is year-over-year returns (YOY) from Apr 26, 2016 to Apr 25, 2017. The table below shows all UITFs and their performance in descending order. Feel free to navigate through each bank and/or each classification.

```{r warning=FALSE, message=FALSE}

# get returns function
get_returns <- function(symbol, price_df, YTD) {
    
    if(YTD == TRUE) {
        price_df <- price_df %>% 
            filter(year(Date) == max(year(Date)))
    }
    
    first_price <- price_df %>% 
        filter(Symbol == symbol) %>% 
        filter(Date == min(Date)) %>% 
        `[[`("NAVPU")
    
    current_price <- price_df %>% 
        filter(Symbol == symbol) %>% 
        filter(Date == max(Date)) %>% 
        `[[`("NAVPU")
    
    (current_price/first_price - 1) * 100
}

# summarize performance of each UITF
fund_performance <- UITF_matrix %>% 
    mutate(YOY = map_dbl(Symbol, get_returns, price_data, FALSE)) %>% 
    mutate(YTD = map_dbl(Symbol, get_returns, price_data, TRUE))
    
# display interactive table
fund_performance %>% 
    arrange(desc(YOY)) %>% 
    mutate(YOY = round(YOY, digits = 2),
           YTD = round(YTD, digits = 2)) %>% 
    select(Bank, Symbol, Classification = `Fund Classification`, YOY, YTD) %>% 
    mutate(Bank = factor(Bank), Classification = factor(Classification)) %>% 
    datatable(filter = "top", 
              class = 'stripe',
              options = list(dom = "pt",
                             pagelength = 20,
                             autoWidth = TRUE
                             )
              )    
    
```
<br />

#### Money Market Funds
```{r warning=FALSE, message=FALSE}



```


### ROI

```{r warning=FALSE, message=FALSE, eval=FALSE}

plot <- price_data %>% 
    group_by(UITF) %>% 
    mutate(Price_Date = ifelse(Date == min(Date), "Old", NA)) %>% 
    mutate(Price_Date = ifelse(Date == max(Date), "New", Price_Date)) %>% 
    na.omit() %>% 
    select(UITF, NAVPU, Price_Date) %>% 
    spread(Price_Date, NAVPU) %>% 
    mutate(YOY = 100*(New/Old - 1)) %>% 
    arrange(desc(YOY)) %>% 
    inner_join(fund_info[, c("Symbol", "Bank", "Fund Name", "Classification", "Risk Classification")], by = c("UITF" = "Symbol")) %>% 
    ggplot(aes(x = Classification, y = YOY, fill = Classification, col = Classification)) +
    geom_violin(width = 1.5) +
    geom_boxplot_interactive(col = "black", fill = "white", width = 0.07, alpha = 0.5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(y = "Year over Year (%)")

ggiraph(ggobj = plot, height_svg=5, width_svg = 9, width = 1)

```
<br />


# Risk Analysis
<br />


# Conclusion
<br />


